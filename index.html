<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Extraction DIM – OCR autonome (V0)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  margin: 20px;
  max-width: 1000px;
}
h1{
  margin-bottom: 5px;
}
.small{
  font-size: 13px;
  color: #444;
}
.controls{
  margin: 15px 0;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}
button{
  padding: 8px 14px;
  cursor: pointer;
}
input[type="number"]{
  width: 70px;
}
#status{
  margin: 10px 0;
  font-weight: bold;
}
textarea{
  width: 100%;
  height: 300px;
  font-family: Consolas, monospace;
  font-size: 13px;
}
canvas{
  border: 1px solid #ccc;
  margin-top: 10px;
  max-width: 100%;
}
</style>
</head>

<body>

<h1>Extraction DIM – OCR autonome (V0)</h1>
<p class="small">
OCR 100 % navigateur. PDF scanné accepté.  
Les données ne quittent pas votre ordinateur.
</p>

<div class="controls">
  <input type="file" id="pdfInput" accept="application/pdf">
  Pages max :
  <input type="number" id="maxPages" value="3" min="1" max="10">
  <button id="btnStart">Analyser</button>
</div>

<div id="status"></div>

<canvas id="canvas"></canvas>

<h3>Texte OCR brut</h3>
<textarea id="ocrText" placeholder="Le texte OCR apparaîtra ici..."></textarea>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- Tesseract.js -->
<script src="https://unpkg.com/tesseract.js@5.0.5/dist/tesseract.min.js"></script>

<script>
const statusEl = document.getElementById("status");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const ocrText = document.getElementById("ocrText");

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

function setStatus(msg){
  statusEl.textContent = msg;
}

async function runOCR(){
  const fileInput = document.getElementById("pdfInput");
  const maxPages = parseInt(document.getElementById("maxPages").value, 10);

  if(!fileInput.files.length){
    alert("Veuillez sélectionner un PDF.");
    return;
  }

  ocrText.value = "";
  setStatus("Chargement du PDF...");

  const file = fileInput.files[0];
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  const totalPages = Math.min(pdf.numPages, maxPages);
  setStatus("PDF chargé. Pages analysées : " + totalPages);

  const worker = await Tesseract.createWorker("fra");

  for(let pageNum = 1; pageNum <= totalPages; pageNum++){
    setStatus("OCR page " + pageNum + " / " + totalPages);

    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 2.0 });

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
      canvasContext: ctx,
      viewport: viewport
    }).promise;

    const { data } = await worker.recognize(canvas);
    ocrText.value +=
      "\n\n===== PAGE " + pageNum + " =====\n\n" +
      data.text;
  }

  await worker.terminate();
  setStatus("OCR terminé.");
}

document.getElementById("btnStart").addEventListener("click", runOCR);
</script>

</body>
</html>

