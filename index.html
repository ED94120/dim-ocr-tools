<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extraction DIM (OCR autonome) - V1 Corrigée</title>

  <style>
    body{font-family:Arial, sans-serif; margin:20px; max-width:1100px; background-color: #f5f5f5;}
    h2{margin:0 0 6px 0; color: #333;}
    .small{font-size:12px; color:#444}
    .card{border:1px solid #ddd; border-radius:10px; padding:14px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.04); margin-bottom: 15px;}
    .cardHeader{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .cardTitle{font-weight:bold; font-size:16px; color: #0056b3;}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-weight:bold}
    input[type="file"]{padding:6px}
    input[type="number"]{width:60px; padding:6px}
    button{padding:10px 14px; cursor:pointer; background: #007bff; color: white; border: none; border-radius: 4px;}
    button:hover{background: #0056b3;}
    button:disabled{opacity:0.5; cursor:not-allowed}
    .status{margin-top:10px; font-weight:bold}
    .ok{color:#1b5e20}
    .err{color:#b00020}
    .muted{color:#666; font-size:12px}
    .grid{display:grid; grid-template-columns: 220px 1fr 110px; gap:10px; align-items:center; margin-top:10px}
    .fieldLabel{font-weight:bold; font-size: 0.9em;}
    .fieldVal{width:100%; padding:8px; box-sizing:border-box; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;}
    .btnCopy, .btnSel{padding:8px 10px; background: #6c757d;}
    details{margin-top:10px; border-top: 1px solid #eee; padding-top: 5px;}
    summary{cursor:pointer; font-weight:bold; font-size: 0.85em; color: #666;}
    .mono{font-family:Consolas, monospace; font-size:12px; white-space:pre-wrap; background: #f0f0f0; padding: 5px; border-radius: 4px;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:bold}
    .pillOk{background:#e7f4ea; color:#1b5e20; border:1px solid #b8e0c1}
    .pillWarn{background:#fff4e5; color:#8a4b00; border:1px solid #ffd29a}
    .pillBad{background:#fde8ea; color:#b00020; border:1px solid #f5b3bb}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.mjs" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
</head>

<body>
  <h2>Extraction DIM (OCR autonome) - V1</h2>
  <div class="small">Extraction locale sécurisée. L’OCR est limité à 10 pages.</div>

  <div class="card" style="margin-top:14px;">
    <div class="cardHeader">
      <div class="cardTitle">Entrée PDF</div>
      <div class="controls">
        <input id="pdfFile" type="file" accept="application/pdf" />
        <label for="maxPages">Pages :</label>
        <input id="maxPages" type="number" min="1" max="10" value="5" />
        <button id="btnAnalyze" type="button">Analyser</button>
        <button id="btnClear" type="button" style="background:#dc3545">Effacer</button>
      </div>
    </div>
    <div id="status" class="status muted">Prêt.</div>
    <div id="progress" class="muted"></div>
    <details>
      <summary>Journal Debug</summary>
      <div class="mono" id="debugLog"></div>
    </details>
  </div>

  <div class="card">
    <div class="cardTitle">Bloc 1 - Document</div>
    <div class="grid" id="blockDoc">
      <div class="fieldLabel">Opérateur</div>
      <input id="doc_operator" class="fieldVal" readonly />
      <button onclick="copyFieldValue('doc_operator')" class="btnCopy" type="button">Copier</button>

      <div class="fieldLabel">Date</div>
      <input id="doc_date" class="fieldVal" readonly />
      <button onclick="copyFieldValue('doc_date')" class="btnCopy" type="button">Copier</button>

      <div class="fieldLabel">Référence Site</div>
      <input id="doc_siteRef" class="fieldVal" readonly />
      <button onclick="copyFieldValue('doc_siteRef')" class="btnCopy" type="button">Copier</button>
    </div>
  </div>

  <div class="card">
    <div class="cardHeader">
        <div class="cardTitle">Bloc 2 - Coordonnées & Localisation</div>
        <span id="coordPill" class="pill pillWarn" style="display:none;"></span>
    </div>
    <div class="grid">
      <div class="fieldLabel">X Lambert II (m)</div>
      <input id="coord_x" class="fieldVal" readonly />
      <button onclick="copyFieldValue('coord_x')" class="btnCopy" type="button">Copier</button>

      <div class="fieldLabel">Y Lambert II (m)</div>
      <input id="coord_y" class="fieldVal" readonly />
      <button onclick="copyFieldValue('coord_y')" class="btnCopy" type="button">Copier</button>

      <div class="fieldLabel">Latitude (WGS84)</div>
      <input id="coord_lat" class="fieldVal" readonly />
      <button onclick="copyFieldValue('coord_lat')" class="btnCopy" type="button">Copier</button>

      <div class="fieldLabel">Longitude (WGS84)</div>
      <input id="coord_lon" class="fieldVal" readonly />
      <button onclick="copyFieldValue('coord_lon')" class="btnCopy" type="button">Copier</button>
      
      <div class="fieldLabel">Commune (BAN)</div>
      <input id="loc_city" class="fieldVal" readonly />
      <button onclick="copyFieldValue('loc_city')" class="btnCopy" type="button">Copier</button>
    </div>
  </div>

  <div class="card">
    <div class="cardTitle">Bloc 3 - Antennes</div>
    <div class="grid">
      <div class="fieldLabel">Azimuts trouvés</div>
      <input id="ant_az_csv" class="fieldVal" readonly />
      <button onclick="copyFieldValue('ant_az_csv')" class="btnCopy" type="button">Copier</button>
    </div>
  </div>

<script type="module">
    // Importation de PDF.js version 4
    import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs';

    const $ = (id) => document.getElementById(id);
    function dbg(m) { $("debugLog").textContent += m + "\n"; console.log(m); }
    function setStatus(m, k) { $("status").textContent = m; $("status").className = "status " + k; }

    // Config Proj4
    proj4.defs("EPSG:27572", "+proj=lcc +lat_1=46.8 +lat_2=45.89891888888889 +lat_0=46.8 +lon_0=0 +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +units=m +no_defs");

    $("btnAnalyze").onclick = async () => {
        const file = $("pdfFile").files[0];
        if (!file) return alert("Sélectionnez un PDF");

        try {
            $("btnAnalyze").disabled = true;
            $("debugLog").textContent = "";
            setStatus("Lecture du fichier...", "ok");

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            const maxP = parseInt($("maxPages").value) || 5;
            const nbPages = Math.min(pdf.numPages, maxP);
            
            // Initialisation Tesseract v5
            const worker = await Tesseract.createWorker('fra');
            
            let allText = "";
            let pagesData = [];

            for (let i = 1; i <= nbPages; i++) {
                setStatus(`Traitement page ${i}/${nbPages}...`, "ok");
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({ canvasContext: context, viewport }).promise;
                
                const { data: { text } } = await worker.recognize(canvas);
                allText += text + "\n";
                pagesData.push(text);
                dbg(`Page ${i} extraite.`);
            }

            await worker.terminate();
            parseData(allText);
            setStatus("Analyse terminée", "ok");

        } catch (e) {
            dbg("ERREUR : " + e.message);
            setStatus("Erreur lors de l'analyse", "err");
        } finally {
            $("btnAnalyze").disabled = false;
        }
    };

    function parseData(text) {
        // Extraction basique regex
        const opMatch = text.match(/Opérateur\s*[:\-]\s*([^\n]+)/i);
        if (opMatch) $("doc_operator").value = opMatch[1].trim();

        const dateMatch = text.match(/Date\s*[:\-]\s*(\d{2}[\/\-]\d{2}[\/\-]\d{4})/);
        if (dateMatch) $("doc_date").value = dateMatch[1];

        const refMatch = text.match(/Code\s*site\s*[:\-]\s*([A-Z0-9_\-]+)/i);
        if (refMatch) $("doc_siteRef").value = refMatch[1];

        // Coordonnées Lambert II
        const xMatch = text.match(/X\s*[:=]\s*(\d{5,7})/i);
        const yMatch = text.match(/Y\s*[:=]\s*(\d{6,7})/i);

        if (xMatch && yMatch) {
            const x = parseFloat(xMatch[1]);
            const y = parseFloat(yMatch[1]);
            $("coord_x").value = x;
            $("coord_y").value = y;

            const wgs84 = proj4("EPSG:27572", "EPSG:4326", [x, y]);
            $("coord_lon").value = wgs84[0].toFixed(6);
            $("coord_lat").value = wgs84[1].toFixed(6);
            
            fetchBAN(wgs84[1], wgs84[0]);
        }

        // Azimuts
        const azimuts = [...text.matchAll(/(\d{1,3})\s*°/g)].map(m => m[1]);
        const uniqueAz = [...new Set(azimuts)].filter(a => a < 360).sort((a,b)=>a-b);
        $("ant_az_csv").value = uniqueAz.join(" ; ");
    }

    async function fetchBAN(lat, lon) {
        try {
            const res = await fetch(`https://api-adresse.data.gouv.fr/reverse/?lat=${lat}&lon=${lon}`);
            const json = await res.json();
            if (json.features && json.features[0]) {
                $("loc_city").value = json.features[0].properties.city;
            }
        } catch(e) { dbg("Erreur BAN API"); }
    }

    window.copyFieldValue = async (id) => {
        const val = $(id).value;
        if (!val) return;
        await navigator.clipboard.writeText(val);
        setStatus("Copié !", "ok");
        setTimeout(() => setStatus("Prêt.", "muted"), 2000);
    };

    $("btnClear").onclick = () => {
        window.location.reload();
    };
</script>
</body>
</html>
